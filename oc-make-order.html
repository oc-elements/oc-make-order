<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../iron-form/iron-form.html">
<link rel="import" href="../oc-core-utils/oc-core-utils.html">
<!-- Ensure Web Animations polyfill is loaded since neon-animation 2.0 doesn't import it -->
<link rel="import" href="../neon-animation/web-animations.html">
<link rel="import" href="../paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../paper-card/paper-card.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../paper-listbox/paper-listbox.html">


<dom-module id="oc-make-order">
  <template>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <style include="shop-button" is="custom-style">

      :host {
        display: block;
        background: #ffffff;
        color: #000;
      }
      .category-heading {
        border-top: 1px #cecece solid;
        border-bottom: 1px #cecece solid;
        background: #f8f8f8;
        color: #000;
      }
      h3 {
        font-size:1.13em !important;
        margin: 10px 0 !important;
      }

      .add-button-row {
        background: #ffffff;
        margin: 15px 0;
      }
      .add-button {
        width: 100%;
        color: #fff;
        background: #2BB673;
      }

      .full-width {
        width:100%;
      }
      paper-dropdown-menu {
        width:100%;
      }
    </style>
    <oc-accounts-api id="accountsApi"></oc-accounts-api>
    <div class="container-fluid">
      <div class="row">
        <div class="col-xs-12 category-heading">
          <h3>Order ID: [[order.id]]</h3>
        </div>
      </div>
      <template is="dom-if" if="[[error.isError]]" >
        <div class="row">
          <div class="col-xs-12">
            <p class="error"><b>Payment Failed!</b> - [[error.message]]</p>
          </div>
        </div>
      </template>
      <div class="row">
        <div class="col-xs-12">
          <paper-dropdown-menu label="From Account" >
            <paper-listbox id="accountId"
                           slot="dropdown-content"
                           selected={{_paymentData.selectedIndex}} >
              <template is="dom-repeat" items="[[_accountsList]]" >
                <paper-item index="[[item.id]]" >[[_capatalize(item.method)]] - [[item.name]]</paper-item>
              </template>
            </paper-listbox>
          </paper-dropdown-menu>
        </div>
      </div>
      <div class="row">
        <div class="col-xs-6">
          Total:
        </div>
        <div class="col-xs-6">
          R [[order.amount]]
        </div>
      </div>
      <div class="row">
        <div class="col-xs-12 text-center add-button-row">
          <paper-button id="submit" class="primary add-button" on-click="_submit" disabled$="{{_loading}}">Pay</paper-button>
        </div>
      </div>
      <div class="row">
        <div class="col-xs-12 category-heading text-center">
          <a href="/"><paper-button class="full-width" disabled$="{{_loading}}">Go Back</paper-button></a>
        </div>
      </div>
    </div>
  </template>

  <script>
      /**
       * `oc-make-order`
       * Flash payment element
       *
       * @customElement
       * @polymer
       * @demo demo/index.html
       */
      class OcMakePayment extends Polymer.Element {
          static get is() { return 'oc-make-order'; }
          static get properties() {
              return {
                  _userId: {
                      type: Number,
                      value: OC.identity.userId
                  },
                  _paymentData: {
                      type : Object,
                      value: {}
                  },
                  organisation: Object,
                  order: Object,
                  _accountList: {
                      type: Array,
                      notify: true
                  },
                  _loading: {
                      type: Boolean,
                      value: false,
                      notify: true
                  },
                  //if the payment failed
                  error: {
                      type: Object,
                      value: {"isError":false},
                      notify: true
                  }
              };
          }

          ready() {
              super.ready();
              this._init();
          }

          _init() {
              this._getUserAccounts();
          }

          _submit() {

              if (!this.$.submit.disabled
                  && this._accountsList.length > 0
                  && this._paymentData.selectedIndex >= 0) {

                  //disables the button
                  this._loading = true;

                  //build the data for the api call
                  let data = {};
                  data.fromAccountId = this._accountsList[this._paymentData.selectedIndex].id;
                  this._paymentData.amount = this.order.amount;
                  data.amount = this._paymentData.amount;

                  //passing the type along too know if should display otp page
                  data.method = this._accountsList[this._paymentData.selectedIndex].method;

                  this.dispatchEvent(new CustomEvent('pay-order-account', {
                          bubbles: true,
                          composed: true,
                          detail: {paymentData: data}
                      })
                  );


                  //disables the button
                  this._loading = false;
              }
          }

          _getUserAccounts() {
              this.$.accountsApi.getUserAccounts(this._userId)
                  .then(function(accountsRequest){
                      this._accountsList = accountsRequest.response.results;
                  }.bind(this));
          }

          //Capatalizes a string
          _capatalize(string){
              return String(string).charAt(0).toUpperCase() + string.slice(1);

          }
      }

      window.customElements.define(OcMakePayment.is, OcMakePayment);
  </script>
</dom-module>
